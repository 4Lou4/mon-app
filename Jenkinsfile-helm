pipeline {
  agent any
  
  environment {
    // Configuration Docker Hub
    IMAGE = "louaymejri/mon-app"
    TAG = "${env.BUILD_NUMBER}"
    
    // Configuration Helm
    CHART_DIR = "./mon-app-chart"
    RELEASE_NAME = "mon-app"
    NAMESPACE = "default"
  }
  
  stages {
    stage('Clone') {
      steps {
        echo "üîÑ Clonage du d√©p√¥t Git..."
        git url: 'https://github.com/4Lou4/mon-app.git', branch: 'main'
      }
    }
    
    stage('Build Docker Image') {
      steps {
        echo "üê≥ Construction de l'image Docker..."
        script {
          sh "docker build -t ${IMAGE}:${TAG} ."
          sh "docker tag ${IMAGE}:${TAG} ${IMAGE}:latest"
        }
      }
    }
    
    stage('Push Image') {
      steps {
        echo "üì§ Publication de l'image sur Docker Hub..."
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-creds',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh '''
            echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
            docker push ${IMAGE}:${TAG}
            docker push ${IMAGE}:latest
            docker logout
          '''
        }
      }
    }
    
    stage('Helm Deploy') {
      steps {
        echo "‚éà D√©ploiement avec Helm..."
        script {
          // Cr√©er le fichier trigger pour le watcher
          sh """
            echo "üöÄ D√©clenchement du d√©ploiement Helm automatique..."
            echo "helm:${TAG}" > /tmp/jenkins-helm-deploy-trigger
            echo "‚úÖ Trigger Helm cr√©√© avec le tag: ${TAG}"
            
            # Attendre que le watcher d√©tecte le trigger
            echo "‚è≥ Attente du d√©ploiement Helm (max 30s)..."
            for i in {1..15}; do
              if [ ! -f /tmp/jenkins-helm-deploy-trigger ]; then
                echo "‚úÖ D√©ploiement Helm d√©clench√© avec succ√®s!"
                exit 0
              fi
              sleep 2
            done
            
            echo "‚ö†Ô∏è  Le d√©ploiement Helm est en cours ou le watcher n'est pas actif"
            echo "Si le watcher n'est pas d√©marr√©, ex√©cutez:"
            echo "  /home/louay/tp3/helm-deploy-watcher.sh &"
          """
        }
      }
    }
  }
  
  post {
    success {
      echo "‚úÖ Pipeline termin√© avec succ√®s!"
      echo "üê≥ Image d√©ploy√©e: ${IMAGE}:${TAG}"
      echo "‚éà Release Helm: ${RELEASE_NAME}"
      echo "üåê Application accessible sur: http://192.168.49.2:30080"
    }
    failure {
      echo "‚ùå Pipeline √©chou√©"
    }
    always {
      echo "üßπ Nettoyage des images locales..."
      sh "docker rmi ${IMAGE}:${TAG} || true"
      sh "docker rmi ${IMAGE}:latest || true"
    }
  }
}
