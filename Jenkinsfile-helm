pipeline {
  agent any
  
  environment {
    // Configuration Docker Hub
    IMAGE = "louaymejri/mon-app"
    TAG = "${env.BUILD_NUMBER}"
    
    // Configuration Helm
    CHART_DIR = "./mon-app-chart"
    RELEASE_NAME = "mon-app"
    NAMESPACE = "default"
  }
  
  stages {
    stage('Clone') {
      steps {
        echo "Cloning Git repository..."
        git url: 'https://github.com/4Lou4/mon-app.git', branch: 'main'
      }
    }
    
    stage('Build Docker Image') {
      steps {
        echo "Building Docker image..."
        script {
          sh "docker build -t ${IMAGE}:${TAG} ."
          sh "docker tag ${IMAGE}:${TAG} ${IMAGE}:latest"
        }
      }
    }
    
    stage('Push Image') {
      steps {
        echo "Pushing image to Docker Hub..."
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-creds',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh '''
            echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
            docker push ${IMAGE}:${TAG}
            docker push ${IMAGE}:latest
            docker logout
          '''
        }
      }
    }
    
    stage('Helm Deploy') {
      steps {
        echo "Deploying with Helm..."
        script {
          sh """
            # Copy chart to a host-accessible location
            cp -r ${CHART_DIR} /tmp/mon-app-chart
            
            # Deploy with Helm
            docker run --rm --network=host \
              -v /home/louay/.kube/config:/root/.kube/config \
              -v /tmp:/tmp \
              alpine/helm:latest upgrade --install ${RELEASE_NAME} /tmp/mon-app-chart \
                --set image.repository=${IMAGE} \
                --set image.tag=${TAG} \
                --namespace ${NAMESPACE} \
                --wait --timeout 120s
            
            # Clean up temp files
            rm -rf /tmp/mon-app-chart
          """
        }
      }
    }
  }
  
  post {
    success {
      echo "Pipeline completed successfully!"
      echo "Deployed image: ${IMAGE}:${TAG}"
      echo "Helm release: ${RELEASE_NAME}"
      echo "Application URL: http://192.168.58.2:30080"
    }
    failure {
      echo "Pipeline failed"
    }
    always {
      echo "Cleaning up local images..."
      sh "docker rmi ${IMAGE}:${TAG} || true"
    }
  }
}
